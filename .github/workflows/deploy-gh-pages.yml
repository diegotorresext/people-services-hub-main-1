name: Build and deploy Vite site to gh-pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

env:
  REPO_PATH: /people-services-hub-main-1

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build (Vite) with repo base
        shell: bash
        run: |
          set -euo pipefail
          echo "Building Vite app with base ${REPO_PATH}/"
          npm run build -- --base ${REPO_PATH}/

      - name: Verify build output (list dist)
        shell: bash
        run: |
          echo "Contents of repo root:"
          ls -la
          echo "Checking dist directory:"
          if [ -d dist ]; then
            echo "dist exists â€” listing files:"
            ls -la dist
            echo "Top of dist/index.html:"
            head -n 40 dist/index.html || true
          else
            echo "ERROR: dist directory was NOT produced by the build."
            echo "Make sure npm run build creates a dist/ folder (vite default)."
            exit 1
          fi

      - name: Ensure SPA fallback (copy index.html -> 404.html)
        shell: bash
        run: |
          set -euo pipefail
          if [ -f dist/index.html ]; then
            cp dist/index.html dist/404.html || true
            echo "Copied dist/index.html -> dist/404.html"
          else
            echo "No dist/index.html to copy"
          fi

      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: dist
          user_name: github-actions[bot]
          user_email: 41898282+github-actions[bot]@users.noreply.github.com
